If **Accordion Items** are populated dynamically from **Content Fragments** and an **author-provided parent path**, along with **Audience Tags for Personalization**, the Table of Contents (TOC) will auto-generate by reading Content Fragments under the specified path. Personalization will ensure content is filtered based on audience tags.

Below is the implementation strategy to handle this requirement:

---

## **Implementation Steps**

1. **Parent Path Configuration**:
   - Authors provide a parent path to fetch all Content Fragments.
   - The path is stored as a dialog property in the Accordion component.

2. **Content Fragments Retrieval**:
   - Use a Sling Model to query and fetch all Content Fragments under the parent path.
   - Apply filtering logic based on **Audience Tags**.

3. **TOC Rendering**:
   - Dynamically generate the Table of Contents above the Accordion Items in the HTL template.

4. **Personalization**:
   - Filter Content Fragments using **Audience Tags**.

---

## **1. Accordion Component Configuration**

Update the Accordion Component's **dialog** to allow authors to set the parent path and audience tags.

**`_cq_dialog.xml`**:
```xml
<jcr:root xmlns:jcr="http://www.jcp.org/jcr/1.0"
          xmlns:nt="http://www.jcp.org/jcr/nt/1.0"
          jcr:primaryType="nt:unstructured"
          sling:resourceType="cq/gui/components/authoring/dialog">

    <content jcr:primaryType="nt:unstructured"
             sling:resourceType="granite/ui/components/coral/foundation/container">
        <items jcr:primaryType="nt:unstructured">

            <!-- Parent Path Field -->
            <parentPath
                jcr:primaryType="nt:unstructured"
                sling:resourceType="granite/ui/components/coral/foundation/form/pathfield"
                fieldLabel="Parent Path"
                name="./parentPath"
                required="{Boolean}true"/>

            <!-- Audience Tags -->
            <audienceTags
                jcr:primaryType="nt:unstructured"
                sling:resourceType="cq/gui/components/common/tagfield"
                fieldLabel="Audience Tags"
                name="./audienceTags"
                required="{Boolean}false"/>

        </items>
    </content>
</jcr:root>
```

---

## **2. Sling Model for Content Fragments Retrieval**

The Sling Model will:
- Fetch **Content Fragments** under the configured parent path.
- Filter results based on **Audience Tags**.
- Prepare data for rendering TOC and Accordion Items.

**`AccordionTOCModel.java`**:
```java
package com.yourproject.models;

import com.adobe.cq.dam.cfm.ContentFragment;
import com.adobe.cq.dam.cfm.ContentFragmentManager;
import com.adobe.cq.dam.cfm.FragmentData;
import com.adobe.cq.sightly.WCMUsePojo;
import org.apache.sling.api.resource.Resource;
import org.apache.sling.api.resource.ResourceResolver;
import javax.inject.Inject;
import javax.jcr.Session;
import java.util.*;
import java.util.stream.Collectors;

public class AccordionTOCModel extends WCMUsePojo {

    @Inject
    private String parentPath;

    @Inject
    private String[] audienceTags;

    private List<Map<String, String>> tocItems = new ArrayList<>();

    @Override
    public void activate() throws Exception {
        ResourceResolver resolver = getResourceResolver();
        ContentFragmentManager cfm = resolver.adaptTo(ContentFragmentManager.class);

        if (parentPath != null && cfm != null) {
            // Retrieve Content Fragments under the parent path
            Iterator<Resource> resources = resolver.getResource(parentPath).listChildren();

            while (resources.hasNext()) {
                Resource resource = resources.next();
                ContentFragment cf = resource.adaptTo(ContentFragment.class);

                if (cf != null && matchesAudienceTags(cf)) {
                    String title = cf.getElement("title").getContent(); // CF Element: Title
                    String id = title.toLowerCase().replace(" ", "-");

                    // Add TOC Entry
                    Map<String, String> tocItem = new HashMap<>();
                    tocItem.put("title", title);
                    tocItem.put("id", id);
                    tocItems.add(tocItem);
                }
            }
        }
    }

    private boolean matchesAudienceTags(ContentFragment cf) {
        if (audienceTags == null || audienceTags.length == 0) {
            return true; // No filtering if no tags are set
        }
        FragmentData tags = cf.getElement("cq:tags");
        return tags != null && Arrays.stream(audienceTags)
            .anyMatch(tag -> Arrays.asList(tags.getValue()).contains(tag));
    }

    public List<Map<String, String>> getTocItems() {
        return tocItems;
    }
}
```

---

## **3. HTL Integration**

Render the Table of Contents above the Accordion Items dynamically.

**`accordion.html`**:
```html
<!-- Use Sling Model -->
<sly data-sly-use.model="com.yourproject.models.AccordionTOCModel"/>

<!-- Accordion Container -->
<div class="accordion">

    <!-- Table of Contents -->
    <div id="table-of-contents" class="table-of-contents">
        <h2>Table of Contents</h2>
        <ul>
            <sly data-sly-list.item="${model.tocItems}">
                <li>
                    <a href="#${item.id}">${item.title}</a>
                </li>
            </sly>
        </ul>
    </div>

    <!-- Accordion Items from Content Fragments -->
    <sly data-sly-list.item="${model.tocItems}">
        <div class="accordion-item" id="${item.id}">
            <h3 class="accordion-title">${item.title}</h3>
            <div class="accordion-content">
                <p>Content for ${item.title} goes here...</p>
            </div>
        </div>
    </sly>
</div>
```

---

## **4. JavaScript for Smooth Scrolling**

Enable smooth scrolling when clicking on TOC links.

**`smooth-scroll.js`**:
```javascript
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("#table-of-contents a").forEach(link => {
        link.addEventListener("click", function (e) {
            e.preventDefault();
            const target = document.getElementById(link.getAttribute("href").substring(1));
            if (target) {
                target.scrollIntoView({ behavior: "smooth", block: "start" });
            }
        });
    });
});
```

---

## **5. Styling the TOC**

Style the Table of Contents for clear visibility.

**`style.css`**:
```css
.table-of-contents {
    margin-bottom: 20px;
    padding: 10px;
    background-color: #f8f9fa;
    border: 1px solid #ddd;
}

.table-of-contents ul {
    list-style: none;
    padding: 0;
}

.table-of-contents li {
    margin: 5px 0;
}

.table-of-contents a {
    color: #0056b3;
    text-decoration: none;
}

.table-of-contents a:hover {
    text-decoration: underline;
}
```

---

## **How It Works**

1. **Author Configuration**:
   - Authors configure the **parent path** and optional **audience tags** in the dialog.

2. **Sling Model**:
   - Retrieves all Content Fragments under the parent path.
   - Filters Content Fragments based on the provided audience tags.

3. **HTL**:
   - Renders the Table of Contents dynamically above the Accordion Items.
   - Outputs each Content Fragment as an Accordion Item.

4. **JavaScript**:
   - Enables smooth scrolling when TOC links are clicked.

---

## **Final Output**

1. The **Table of Contents** is automatically rendered above all Accordion Items.
2. Content Fragments are dynamically fetched and displayed as Accordion Items.
3. Audience tags ensure **personalized filtering** of Content Fragments.
4. Smooth navigation allows users to scroll to the corresponding Accordion Item.

This solution is dynamic, scalable, and meets the requirement for both content generation and personalization. Let me know if further refinements are needed! ðŸš€
