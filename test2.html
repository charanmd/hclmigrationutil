To ensure that the **Table of Contents (TOC)** is **automatically added** inside the Accordion component **above all Accordion Items**, as shown in the image, we need to slightly update the previous implementation.

Hereâ€™s the updated solution:

---

## **Updated Implementation Overview**
1. Modify the **Accordion Parent Component** to dynamically include the TOC.
2. Ensure the TOC is rendered **above all Accordion Items** inside the Accordion container.
3. The logic will dynamically identify all Accordion Items added to the page using a query.

---

### **1. HTL - Updated Accordion Component**

In the **Accordion Parent Component**, render the Table of Contents before rendering the Accordion Items.

**`accordion.html`**:
```html
<!-- Use Sling Model for TOC -->
<sly data-sly-use.model="com.yourproject.models.AccordionTOCModel"/>

<!-- Accordion Wrapper -->
<div class="accordion">

    <!-- Table of Contents Above Accordion Items -->
    <div id="table-of-contents" class="table-of-contents">
        <h2>Table of Contents</h2>
        <ul>
            <sly data-sly-list.item="${model.tocItems}">
                <li>
                    <a href="#${item['title'].split(',')[1]}">
                        ${item['title'].split(',')[0]}
                    </a>
                </li>
            </sly>
        </ul>
    </div>

    <!-- Render Accordion Items -->
    <sly data-sly-list.item="${resource.getChildren}">
        <sly data-sly-resource="${item.path @ resourceType='yourproject/components/accordionitem'}"></sly>
    </sly>
</div>

<!-- Include JavaScript -->
<script src="/etc.clientlibs/yourproject/components/accordion/clientlibs/site.min.js"></script>
```

---

### **2. Java Logic - Sling Model for Dynamic TOC**

The **Sling Model** remains similar but dynamically identifies all Accordion Items within the Accordion.

**`AccordionTOCModel.java`**:
```java
package com.yourproject.models;

import com.adobe.cq.sightly.WCMUsePojo;
import org.apache.sling.api.resource.Resource;
import org.apache.sling.api.resource.ResourceResolver;

import javax.jcr.Node;
import javax.jcr.RepositoryException;
import javax.jcr.Session;
import javax.jcr.query.Query;
import javax.jcr.query.QueryManager;
import javax.jcr.query.QueryResult;
import javax.jcr.query.Row;
import java.util.*;

public class AccordionTOCModel extends WCMUsePojo {

    private List<Map<String, String>> tocItems = new ArrayList<>();

    @Override
    public void activate() throws Exception {
        ResourceResolver resolver = getResourceResolver();
        Session session = resolver.adaptTo(Session.class);

        String currentPath = getResource().getPath();
        String queryStatement = "SELECT * FROM [nt:unstructured] AS item "
                + "WHERE ISCHILDNODE(item, '" + currentPath + "') "
                + "AND item.[sling:resourceType] = 'yourproject/components/accordionitem'";

        QueryManager queryManager = session.getWorkspace().getQueryManager();
        Query query = queryManager.createQuery(queryStatement, Query.JCR_SQL2);
        QueryResult result = query.execute();

        for (Row row : result.getRows()) {
            Node node = row.getNode();
            String title = node.hasProperty("title") ? node.getProperty("title").getString() : "Untitled";
            String id = title.toLowerCase().replace(" ", "-");
            tocItems.add(Collections.singletonMap("title", title + "," + id));
        }
    }

    public List<Map<String, String>> getTocItems() {
        return tocItems;
    }
}
```

---

### **3. HTL for Accordion Item IDs**

Ensure each Accordion Item has a unique ID based on its title.

**`accordionitem.html`**:
```html
<div class="accordion-item" id="${properties.title @ context='attribute'}">
    <h3 class="accordion-title">${properties.title}</h3>
    <div class="accordion-content">
        <sly data-sly-include="body.html"></sly>
    </div>
</div>
```

---

### **4. JavaScript for Smooth Scrolling**

Add JavaScript to enable smooth scrolling when a TOC link is clicked.

**`toc-generator.js`**:
```javascript
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("#table-of-contents a").forEach(link => {
        link.addEventListener("click", function (e) {
            e.preventDefault();
            const target = document.querySelector(link.getAttribute("href"));
            if (target) {
                target.scrollIntoView({ behavior: "smooth", block: "start" });
            }
        });
    });
});
```

---

### **5. CSS Styling for TOC**

Add styling for the Table of Contents for better appearance.

**`style.css`**:
```css
.table-of-contents {
    margin-bottom: 20px;
    padding: 10px;
    background: #f8f9fa;
    border: 1px solid #ddd;
}

.table-of-contents h2 {
    margin: 0 0 10px;
    font-size: 18px;
}

.table-of-contents ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
}

.table-of-contents li {
    margin: 5px 0;
}

.table-of-contents a {
    color: #0056b3;
    text-decoration: none;
}

.table-of-contents a:hover {
    text-decoration: underline;
}
```

---

### **How It Works**

1. **Accordion Parent Component**:
   - The TOC is added at the top of the Accordion container.
   - It dynamically lists all Accordion Items (using the Sling Model query).

2. **Sling Model**:
   - Queries all child nodes with `sling:resourceType` as `accordionitem`.
   - Extracts the titles of Accordion Items and assigns unique IDs.

3. **Accordion Items**:
   - Each item has an `id` based on its title, allowing the TOC links to scroll to their respective sections.

4. **JavaScript**:
   - Enables smooth scrolling for TOC links.

5. **Styling**:
   - Ensures the TOC appears clean and visually distinct.

---

### **Final Output**

When the Accordion component is added to any page:
- A **Table of Contents** is automatically rendered at the top of the Accordion, listing all Accordion Item titles.
- Clicking on a TOC entry scrolls smoothly to the corresponding Accordion Item section.

This solution is clean, dynamic, and works seamlessly for any Accordion added to a page. Let me know if you need further refinements! ðŸš€
