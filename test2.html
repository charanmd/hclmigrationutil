To **auto-generate a Table of Contents (TOC)** for an AEM page by reading **Accordion Items** dynamically using a query, you can leverage the **JCR query mechanism** (using Sling models or Sightly Use-API) combined with **HTL** to render the TOC. Hereâ€™s a breakdown of ideas and implementation strategies:

---

## **1. Using Query to Retrieve Accordion Items**

You can use the **`QueryBuilder`** API or **JCR SQL2** query to find child nodes representing Accordion Items under the Accordion parent node.

### **JCR SQL2 Query Example**
Assuming the Accordion Items have a resource type `yourproject/components/accordionitem`, the query could look like this:
```sql
SELECT * FROM [nt:unstructured] AS item
WHERE ISDESCENDANTNODE(item, '/content/mysite/page/jcr:content') 
AND item.[sling:resourceType] = 'yourproject/components/accordionitem'
```

---

## **2. Implementation with a Sling Model**

A Sling Model can execute the query and pass the data to the HTL template for rendering.

### **Sling Model Code**

Create a Sling Model to fetch all Accordion Items under a specific parent node:

**`AccordionTOCModel.java`**:
```java
package com.yourproject.models;

import com.adobe.cq.sightly.WCMUsePojo;
import org.apache.sling.api.resource.Resource;
import org.apache.sling.api.resource.ResourceResolver;
import org.apache.sling.api.wrappers.ValueMapDecorator;

import javax.jcr.Node;
import javax.jcr.RepositoryException;
import javax.jcr.Session;
import javax.jcr.query.Query;
import javax.jcr.query.QueryManager;
import javax.jcr.query.QueryResult;
import javax.jcr.query.Row;
import java.util.*;

public class AccordionTOCModel extends WCMUsePojo {

    private List<Map<String, String>> tocItems = new ArrayList<>();

    @Override
    public void activate() throws Exception {
        ResourceResolver resolver = getResourceResolver();
        Session session = resolver.adaptTo(Session.class);

        String currentPagePath = getCurrentPage().getPath();
        String queryStatement = "SELECT * FROM [nt:unstructured] AS item "
                + "WHERE ISDESCENDANTNODE(item, '" + currentPagePath + "') "
                + "AND item.[sling:resourceType] = 'yourproject/components/accordionitem'";

        QueryManager queryManager = session.getWorkspace().getQueryManager();
        Query query = queryManager.createQuery(queryStatement, Query.JCR_SQL2);
        QueryResult result = query.execute();

        // Parse results
        for (Row row : result.getRows()) {
            Node node = row.getNode();
            String title = node.hasProperty("title") ? node.getProperty("title").getString() : "Untitled";
            String id = node.getPath().replace("/", "_"); // Generate unique ID
            tocItems.add(Collections.singletonMap("title", title + "," + id));
        }
    }

    public List<Map<String, String>> getTocItems() {
        return tocItems;
    }
}
```

---

## **3. HTL Integration**

Use the **AccordionTOCModel** in your **Accordion HTL** to render the dynamic Table of Contents.

**`accordion.html`**:
```html
<!-- Use Sling Model -->
<sly data-sly-use.model="com.yourproject.models.AccordionTOCModel"/>

<!-- Table of Contents -->
<div id="table-of-contents" class="table-of-contents">
    <h2>Table of Contents</h2>
    <ul>
        <sly data-sly-list.item="${model.tocItems}">
            <li>
                <a href="#${item['title'].split(',')[1]}">
                    ${item['title'].split(',')[0]}
                </a>
            </li>
        </sly>
    </ul>
</div>

<!-- Accordion Sections -->
<div class="accordion">
    <sly data-sly-list.item="${resource.getChildren}">
        <div class="accordion-item" id="${item.name}">
            <h3 class="accordion-title">${item.title}</h3>
            <div class="accordion-content">
                <sly data-sly-include="body.html"></sly>
            </div>
        </div>
    </sly>
</div>
```

---

## **4. Explanation of the Solution**

1. **JCR Query**:
   - Retrieves all nodes of type `nt:unstructured` under the page content path.
   - Filters nodes with `sling:resourceType` equal to `yourproject/components/accordionitem`.

2. **Sling Model**:
   - Executes the JCR SQL2 query and processes the results.
   - Extracts the `title` and generates unique IDs based on the node path.
   - Provides a list of TOC items as `Map` objects with `title` and `id`.

3. **HTL Rendering**:
   - Uses the `AccordionTOCModel` to iterate over the TOC items.
   - Outputs links that point to corresponding Accordion sections via `id`.

4. **Accordion Section IDs**:
   - IDs for each Accordion Item are derived from the node path to ensure uniqueness.

---

## **5. Advantages of This Approach**

1. **Dynamic Querying**: The TOC automatically updates as Accordion Items are added or removed.
2. **Scalable**: Supports pages with multiple Accordion Items.
3. **Separation of Concerns**: Business logic is encapsulated in the Sling Model, and HTL only handles rendering.

---

## **6. Next Steps**

1. Enhance error handling in the Sling Model for edge cases.
2. Add smooth scroll behavior in JavaScript for better navigation.
3. Optimize query performance by restricting depth or limiting results.

Let me know if you need further assistance refining this solution! ðŸš€
